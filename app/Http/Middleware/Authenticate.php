<?php namespace App\Http\Middleware;use Closure;use Illuminate\Contracts\Auth\Guard;use Auth;use DB;use Session;use App;use Middleware;class Authenticate {	/**	 * The Guard implementation.	 *	 * @var Guard	 */	protected $auth;	public $emp_id;	/**	* Create a new filter instance.	*	* @param  Guard  $auth	* @return void	*/	public function __construct(Guard $auth)	{			$this->auth = $auth;		date_default_timezone_set('Asia/Phnom_Penh');        $language_id = Session::get('applangId');        if($language_id==1){          App::setLocale('kh');        }else if($language_id==3){          App::setLocale('cn');        }else if($language_id==4){          App::setLocale('ch');        }else{          App::setLocale('en');        }	}	/**	 * Handle an incoming request.	 *	 * @param  \Illuminate\Http\Request  $request	 * @param  \Closure  $next	 * @return mixed	 */	public function handle($request, Closure $next)	{			// echo"testing";		if ($this->auth->guest())		{			if ($request->ajax())			{				return response('Unauthorized.', 401);			}			else			{				return redirect()->guest('auth/login');			}		}		$menu_code ='y5_m01';		// if(isset($_REQUEST['menuCode'])){		// 	$menu_code = $_REQUEST['menuCode'];		// }		$request_uri= $_SERVER['REQUEST_URI'];		explode('?', $request_uri);		$menu_link = ltrim(explode('?', $request_uri)[0]);		$new_menu_link = ltrim($menu_link, '/');				$group_id = Auth::user()->group_id;		$group_role = DB::table('group_role')->where('group_id', $group_id)->pluck('id');		$group_role_id = $group_role[0];		$group_role_detail = DB::table('group_role_detail')								->where('group_role_id', $group_role_id)								->where('menu_code', $menu_code)								->pluck('menu_code');				// condition if has_menu_code		if(isset($_REQUEST['menuCode']) && $menu_code!=''){			// if has menu_code_in_group_role			if($group_role_detail){								$read_arr = DB::table('group_role_detail')->where('menu_code','=', $menu_code)->where('group_role_id','=',$group_role_id)->pluck('read');				$write_arr = DB::table('group_role_detail')->where('menu_code','=', $menu_code)->where('group_role_id','=',$group_role_id)->pluck('write');				$read = $read_arr[0];				$write = $write_arr[0];				if($read==1 && $write==1){					return $next($request);				}else if($read==0){					// return response()->view('admin.common.404Error');				}else{					$has_menu_link = DB::table('menu')->where('menu_link','=', $new_menu_link)->pluck('menu_code');					if($has_menu_link){						return $next($request);					}else{						if($menu_code=='y5_m12'){							return $next($request);						}else{							// return response()->view('admin.common.404Error');						}					}				}			}else{				// return response()->view('admin.common.404Error');			}			// else Codition if has menu_code_in_group_role		}else{			$menu_code_default_access = DB::table('group_role_detail')->where('menu_code','=', $menu_code)->where('group_role_id','=',$group_role_id)->pluck('read');			if($menu_code_default_access && $request_uri=='/'){				return $next($request);					}else{				// return response()->view('admin.common.404Error');			}		}		// End condition if has_menu_code		return $next($request);	}}